<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pachangam Table</title>
    <style>
        body {
            font-family: Calibri;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background-color: #333;
            overflow: hidden;
            color: white;
            padding: 1rem;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 14px 20px;
            display: inline-block;
        }

        .navbar a:hover {
            background-color: #ddd;
            color: black;
        }

        table {
            width: 80%;
            border-collapse: collapse;
            border: 2px solid black;
            margin: 20px auto;
        }

        th, td {
            border: 1px solid #000;
            padding: 0px;
            text-align: center;
            white-space: nowrap;
            font-size: 15px;
            font-weight: normal;
        }

        th {
            font-weight: bold;
        }

        .header-in-table {
            background-color: #70AD47;
        }

        td, th {
            height: 20px;
            width: 45px;
        }

        .sunrise-today {
            background-color: #ED7D31;
        }

        .sunset-today {
            background-color: #FF0000;
        }

        .blue-background {
            background-color: #002060;
        }

        .sunrise-tmrw {
            background-color: #FFD966;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <a href="#">Home</a>
        <a href="#">About</a>
        <a href="#">Contact</a>
    </div>

    <!-- City Name and Date Input and Form -->
    <div style="text-align: center; margin: 20px;">
        <label for="cityName">Enter City Name:</label>
        <input type="text" id="cityName" name="cityName" value="Boston">
        <label for="dateInput">Enter Date:</label>
        <input type="date" id="dateInput" name="dateInput" value="04/08/2024">
        <button onclick="fetchAndUpdateTimes()">Get Pachangam</button>
    </div>

    <!-- Pachangam Request Form -->
    <div style="text-align: center; margin: 20px;">
        <label for="sunriseToday">Sunrise Today:</label>
        <input id="sunriseToday" name="sunriseToday" value="05:45:00">
        <label for="sunsetToday">Sunset Today:</label>
        <input id="sunsetToday" name="sunsetToday" value="18:04:00">
        <label for="sunriseTmrw">Sunrise Tomorrow:</label>
        <input id="sunriseTmrw" name="sunriseTmrw" value="05:45:00">
        <label for="weekday">Weekday:</label>
        <input type="text" id="weekday" name="weekday" value="Monday">
        <button onclick="updateTable()">Update Table</button>
    </div>

    <!-- Table -->
    <table>
        <thead>
            <tr>
                <th class="header-in-table">STRAT</th>
                <th class="header-in-table">END</th>
                <th class="header-in-table" id="weekday-html">Monday</th>
                <th class="header-in-table">STRAT</th>
                <th class="header-in-table">END</th>
                <th class="header-in-table">S.no</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- Table rows will be generated by JavaScript -->
        </tbody>
    </table>

    <script>
// Function to fetch coordinates based on the city name
// Function to fetch coordinates and time zone based on the city
async function fetchCoordinates(city) {
    const apiKey = '699522e909454a09b82d1c728fc79925'; // Your API key
    try {
        const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(city)}&key=${apiKey}`);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        if (data.results.length > 0) {
            const { lat, lng } = data.results[0].geometry;
            const timeZone = data.results[0].annotations.timezone.name;
            return { lat, lng, timeZone }; // Return all required values
        } else {
            throw new Error('City not found');
        }
    } catch (error) {
        console.error('Error fetching coordinates:', error);
        alert('There was an error fetching the coordinates. Please check the city name or try again later.');
        return null; // Ensure null is returned in case of error
    }
}



// Function to convert UTC time to local time based on time zone
const convertToLocalTime = (utcDate, timeZone) => {
    const date = new Date(utcDate);
    // Use timeZone option to ensure proper conversion
    return date.toLocaleString('en-US', { timeZone, hour12: false }).split(' ')[1];
};

// Function to fetch sunrise and sunset times for a given date
async function fetchSunTimes(lat, lng, date, timeZone) {
    try {
        const response = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&formatted=0&date=${date}`);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        const results = data.results;

        // Convert UTC time to local time based on timeZone
        return {
            sunrise: convertToLocalTime(results.sunrise, timeZone),
            sunset: convertToLocalTime(results.sunset, timeZone),
            solar_noon: convertToLocalTime(results.solar_noon, timeZone),
            civil_twilight_begin: convertToLocalTime(results.civil_twilight_begin, timeZone),
            civil_twilight_end: convertToLocalTime(results.civil_twilight_end, timeZone),
            nautical_twilight_begin: convertToLocalTime(results.nautical_twilight_begin, timeZone),
            nautical_twilight_end: convertToLocalTime(results.nautical_twilight_end, timeZone),
            astronomical_twilight_begin: convertToLocalTime(results.astronomical_twilight_begin, timeZone),
            astronomical_twilight_end: convertToLocalTime(results.astronomical_twilight_end, timeZone),
        };
    } catch (error) {
        console.error('Error fetching sun times:', error);
        alert('There was an error fetching sun times. Please try again later.');
        return null;
    }
}

// Example usage
async function getSunTimesForCity(city, date) {
    const coords = await fetchCoordinates(city);
    if (coords) {
        const sunTimes = await fetchSunTimes(coords.lat, coords.lng, date, coords.timeZone);
        console.log(sunTimes);
        return sunTimes;
    }
    return null;
}


        // Function to get the weekday name from a date
        function getWeekday(dateString) {
            const date = new Date(dateString);
            const options = { weekday: 'long' };
            return date.toLocaleDateString('en-US', options);
        }

        async function fetchAndUpdateTimes() {
    const city = document.getElementById('cityName').value;
    const userEnteredDate = document.getElementById('dateInput').value; // Get the date entered by the user

    if (!city) {
        alert('Please enter a city name.');
        return;
    }

    // Use user-entered date if provided, otherwise use current date
    const date = userEnteredDate || new Date().toISOString().split('T')[0];
    
    try {
        const coords = await fetchCoordinates(city); // Fetch coordinates and time zone

        if (coords) {
            const { lat, lng, timeZone } = coords; // Destructure timeZone here

            // Fetch sun times for today
            const todayTimes = await fetchSunTimes(lat, lng, date, timeZone);
            if (!todayTimes) return;

            const todayWeekday = getWeekday(date);
            const tomorrow = new Date(date);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDate = tomorrow.toISOString().split('T')[0];

            // Fetch sun times for tomorrow
            const tomorrowTimes = await fetchSunTimes(lat, lng, tomorrowDate, timeZone);
            if (!tomorrowTimes) return;

            const sunriseToday = todayTimes.sunrise;
            const sunsetToday = todayTimes.sunset;
            const sunriseTmrw = tomorrowTimes.sunrise;
            const tomorrowWeekday = getWeekday(tomorrowDate);

            // Print times and weekdays to the console
            console.log('Sunrise Today:', sunriseToday);
            console.log('Sunset Today:', sunsetToday);
            console.log('Sunrise Tomorrow:', sunriseTmrw);
            console.log('Today\'s Weekday:', todayWeekday);

            // Update input fields
            document.getElementById('sunriseToday').value = sunriseToday;
            document.getElementById('sunsetToday').value = sunsetToday;
            document.getElementById('sunriseTmrw').value = sunriseTmrw;
            document.getElementById('weekday').value = todayWeekday;

            // Update the table
            updateTable();
        } else {
            console.error('Failed to get coordinates.');
        }
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}


// Helper functions for time conversion
function timeToSeconds(time) {
    const [hours, minutes, seconds] = time.split(':').map(Number);
    return hours * 3600 + minutes * 60 + (seconds || 0);
}

function secondsToTime(seconds) {
    seconds = Math.round(seconds % 86400);
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}



function updateTable() {
    const sunriseToday = document.getElementById('sunriseToday').value;
    const sunsetToday = document.getElementById('sunsetToday').value;
    const sunriseTmrw = document.getElementById('sunriseTmrw').value;
    const weekday = document.getElementById('weekday').value;
    const total = "24:00:00";

    const sunriseTodaySec = timeToSeconds(sunriseToday);
    const sunsetTodaySec = timeToSeconds(sunsetToday);
    const sunriseTmrwSec = timeToSeconds(sunriseTmrw);
    const totalSec = timeToSeconds(total);

    const interval1 = (sunsetTodaySec - sunriseTodaySec) / 30;
    const interval2 = ((totalSec + sunriseTmrwSec) - sunsetTodaySec) / 30;
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = ''; // Clear existing table rows
    
    let currentSec = sunriseTodaySec;
    const columnD = [];

    // Generate rows for 30 cells
    for (let i = 0; i < 30; i++) {
        const start = secondsToTime(currentSec);
        currentSec += interval1;
        const end = secondsToTime(currentSec);

        tableBody.innerHTML += `
            <tr>
                <td>${start}</td>
                <td>${end}</td>
                <td></td>
                <td></td>
                <td></td>
                <td>${i + 1}</td>
                <td></td>
                <td></td>
            </tr>
        `;
    }

 // Levenshtein distance function
function levenshtein(a, b) {
    let tmp;
    let i, j;
    const alen = a.length;
    const blen = b.length;
    const arr = [];
    
    if (alen === 0) { return blen; }
    if (blen === 0) { return alen; }

    for (i = 0; i <= blen; i++) { arr[i] = [i]; }
    for (j = 0; j <= alen; j++) { arr[0][j] = j; }

    for (i = 1; i <= blen; i++) {
        for (j = 1; j <= alen; j++) {
            tmp = a[j - 1] === b[i - 1] ? 0 : 1;
            arr[i][j] = Math.min(arr[i - 1][j] + 1, arr[i][j - 1] + 1, arr[i - 1][j - 1] + tmp);
        }
    }

    return arr[blen][alen];
}

// Possible correct day names
const dayNames = {
    "Monday": ["monday", "mon", "mondy", "moday"],
    "Tuesday": ["tuesday", "tues", "tuesd", "tueday"],
    "Wednesday": ["wednesday", "wed", "wednes", "wensday"],
    "Thursday": ["thursday", "thur", "thurs", "thurday"],
    "Friday": ["friday", "fri", "frid", "fryday"],
    "Saturday": ["saturday", "sat", "satur", "saterday"],
    "Sunday": ["sunday", "sun", "sund", "sundey"]
};

// Find the closest match for a given input
function findClosestDay(input) {
    let minDistance = Infinity;
    let closestDay = "";
    
    const normalizedInput = input.toLowerCase();
    
    for (const [day, variants] of Object.entries(dayNames)) {
        for (const variant of variants) {
            const distance = levenshtein(normalizedInput, variant.toLowerCase());
            if (distance < minDistance) {
                minDistance = distance;
                closestDay = day;
            }
        }
    }
    
    return closestDay;
}

const rows = tableBody.getElementsByTagName('tr');
let previousD = sunriseTodaySec;

for (let i = 0; i < rows.length; i++) {
    const cells = rows[i].getElementsByTagName('td');
    if (cells.length > 0) {
        // Column D values
        if (i === 0) {
            previousD = sunriseTodaySec; // Start value for D0
            cells[3].textContent = secondsToTime(previousD);
        } else {
            previousD += interval1;
            cells[3].textContent = secondsToTime(previousD);
        }

        // Update Column E with next Column D value
        if (i < rows.length - 1) {
            const nextD = timeToSeconds(cells[3].textContent);
            cells[4].textContent = secondsToTime(nextD + interval2);
        }
        
        let wkd = document.getElementById("weekday-html");
        let closestDay = findClosestDay(weekday); // Find the closest day name

        // Apply blue background to specific rows in Column C based on closest day
        const weekdayRows = {
            "Monday": [0, 5, 12, 13, 21, 26, 29],
            "Tuesday": [4, 9, 10, 11, 13, 14, 15, 16, 17, 20, 22, 23, 24, 26],
            "Wednesday": [2, 3, 6, 7, 8, 9, 11, 21, 29, 31],
            "Thursday": [4, 7, 10, 15, 16, 17, 18, 20, 21, 22, 25, 26, 29, 30],
            "Friday": [3, 6, 8, 10, 16, 18, 20, 21, 24, 25, 26, 27, 28, 30],
            "Saturday": [2, 10, 11, 13, 14, 19, 24, 25, 27],
            "Sunday": [2, 10, 11, 13, 14, 19, 24, 25, 27]
        };

        const dayRows = weekdayRows[closestDay] || [];
        if (dayRows.includes(i)) {  
            cells[2].style.backgroundColor = '#002060'; // Apply blue color
            wkd.innerHTML = closestDay;
        }

        const update = [0, 1, 2, 3, 4, 5];
        if (update.includes(i)) { 
            if (update[i] === 0) {
                cells[6].textContent = secondsToTime(interval1);
                cells[6].style.backgroundColor = '#B4C6E7';  
            }
            if (update[i] === 1) {
                cells[6].textContent = secondsToTime(interval2); 
                cells[6].style.backgroundColor = '#B4C6E7';  
            }
            if (update[i] === 2) {
                cells[6].textContent = total;
                cells[6].style.backgroundColor = '#B4C6E7';   
            }
            if (update[i] === 3) {
                cells[6].textContent = "sunriseToday";
                cells[7].textContent = sunriseToday;
                cells[6].style.backgroundColor = '#ED7D31'; 
                cells[7].style.backgroundColor = ''; 
            }
            if (update[i] === 4) {
                cells[6].textContent = "sunsetToday";
                cells[7].textContent = sunsetToday;  
                cells[6].style.backgroundColor = '#FF0000'; 
                cells[7].style.backgroundColor = '';  
            }
            if (update[i] === 5) {
                cells[6].textContent = "sunriseTmrw";
                cells[7].textContent = sunriseTmrw;   
                cells[6].style.backgroundColor = '#FFD966'; 
                cells[7].style.backgroundColor = ''; 
            }
        }
    }
}

    const lastA = secondsToTime(currentSec);
    const lastD = secondsToTime(previousD + interval2);

    const lastRow = document.createElement('tr');
    lastRow.innerHTML = `
        <td>${lastA}</td>
        <td></td>
        <td></td>
        <td>${lastD}</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    `;
    tableBody.appendChild(lastRow);
}

document.addEventListener("DOMContentLoaded", function() {
    updateTable();
});
    </script>
</body>
</html>
